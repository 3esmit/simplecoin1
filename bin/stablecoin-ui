#!/usr/bin/env node
var express = require("express")
var morgan = require("morgan")

var PORT = process.env.PORT || 80
var URL = `http://localhost:${PORT}`

var env = {}
for (var key in process.env) {
  if (/^APP_/.test(key) || key == "PORT") {
    env[key] = process.env[key]
  }
}

function getenv(name) {
  if (name in env) return env[name]
  console.error(`Missing environment variable: ${name}`)
  process.exit(1)
}

var geth = ["geth"]
if (getenv("APP_ENV") == "morden") geth.push("--testnet")
else if (env.APP_ENV == "live") ;
else console.warn(`Warning: don't recognize APP_ENV=${env.APP_ENV}`)
geth.push("--rpc")
geth.push(`--rpcport=${getenv("APP_RPC_PORT")}`)
geth.push(`\\\n     --rpccorsdomain=${URL}`)

var app = express()
app.use(express.static("public"))
app.use(morgan("dev"))
app.get("/env", (req, res) => res.json(env))

app.listen(PORT, () => console.log(`
>>>> Maker's simple stablecoin

Serving stablecoin UI at <${URL}>.

${Object.keys(env).sort().map(key => `   ${key}=${env[key]}`).join("\n")}

Expecting the equivalent of this at port ${env.APP_RPC_PORT}:

   ${geth.join(" ")}

Report bugs to <https://github.com/makerdao/stablecoin-ui>.
`))
